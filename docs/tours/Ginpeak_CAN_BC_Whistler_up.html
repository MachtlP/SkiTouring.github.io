<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ginpeak • Touring Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/book.css" />
  <link rel="stylesheet" href="../css/map.css" />
  <link rel="stylesheet" href="../css/tour.css" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    #map { height: 420px; width: 100%; border-radius: 12px; }
  </style>
</head>

<body>
  <main class="tour-wrap">

    <nav class="tour-nav">
      <a href="../guide.html">← Back to guide</a>
      <a href="../tracks/Ginpeak_CAN_BC_Whistler_up.gpx" download class="btn">Download GPX</a>
    </nav>

    <header class="tour-header">
      <h1 class="tour-title">Ginpeak</h1>
      <p class="tour-sub">British Columbia • Whistler</p>
    </header>

    <section class="tour-map">
      <div id="map"></div>
    </section>

    <section class="tour-content">
      <p>&lt;!--</p>
<p>Template for: Ginpeak_CAN_BC_Whistler_up</p>
<p>This file will be auto-created if missing.</p>
<p>Write content only — metadata comes from tours.geojson.</p>
<p>--&gt;</p>
<h1>Overview</h1>
<p>TODO</p>
<h2>Quick facts</h2>
<ul>
<li><strong>Start / trailhead:</strong> TODO</li>
<li><strong>Best season:</strong> TODO</li>
<li><strong>Aspect / elevation band:</strong> TODO</li>
<li><strong>Typical time:</strong> TODO</li>
<li><strong>Typical distance / vert:</strong> TODO</li>
<li><strong>Group size / parking:</strong> TODO</li>
</ul>
<h1>Access</h1>
<p>TODO</p>
<h1>Route</h1>
<h2>Ascent</h2>
<p>TODO</p>
<h2>Descent</h2>
<p>TODO</p>
<h1>Avalanche terrain &amp; hazards</h1>
<ul>
<li><strong>Avalanche problems to watch:</strong> TODO</li>
<li><strong>Terrain traps:</strong> TODO</li>
<li><strong>Common “gotchas”:</strong> TODO</li>
<li><strong>Notes on safe options / bail-outs:</strong> TODO</li>
</ul>
<h1>Conditions &amp; timing</h1>
<ul>
<li>When the route is best (time of day, stability patterns, melt-freeze, etc.)</li>
<li>What makes it a “no-go”</li>
<li>Any micro-weather notes (wind loading zones, sun hits early, etc.)</li>
</ul>
<h1>Variants</h1>
<ul>
<li>Not outlined yet</li>
</ul>
<h1>Photos</h1>
<p>&gt; Add photos by dropping images into `docs/photos/Ginpeak_CAN_BC_Whistler_up/`.</p>
<p>Optional captions:</p>
<ul>
<li>`01.jpg` — TODO caption</li>
<li>`02.jpg` — TODO caption</li>
</ul>
<h1>References / links</h1>
<ul>
<li><a href="https://example.com">Link title</a></li>
<li><a href="https://avalanche.ca/">Avalanche Canada</a></li>
</ul>
<p>---</p>
<p><strong>Disclaimer:</strong> This is a personal route note, not a guarantee of safety. Always assess current conditions and consult the avalanche bulletin.</p>
    </section>

  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const slug = "Ginpeak_CAN_BC_Whistler_up";
    const detailUrl = `../data/tours_detail/${slug}.geojson`;

    const map = L.map("map", { zoomControl: true });

    // --- Base layers ---
    const openTopo = L.tileLayer(
      "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 17,
        attribution: "&copy; OpenStreetMap contributors, SRTM | OpenTopoMap"
      }
    );

    const openStreet = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }
    );

    // Default basemap
    openTopo.addTo(map);

    // Layer control
    L.control.layers(
      { "Topo": openTopo, "Street": openStreet },
      null,
      { collapsed: true }
    ).addTo(map);

    // Fallback view (only used if loading fails)
    map.setView([50.0, -123.0], 7);

    function pickFeature(gj) {
      if (!gj || typeof gj !== "object") return null;
      if (gj.type === "Feature") return gj;
      if (gj.type === "FeatureCollection" && Array.isArray(gj.features) && gj.features.length) {
        return gj.features[0];
      }
      return null;
    }

    function coordsToLatLngs(geometry) {
      // Supports LineString and MultiLineString
      const t = geometry?.type;
      const c = geometry?.coordinates;

      if (!t || !c) return [];

      if (t === "LineString") {
        return c
          .filter(p => Array.isArray(p) && p.length >= 2)
          .map(p => [Number(p[1]), Number(p[0])]); // [lat, lon]
      }

      if (t === "MultiLineString") {
        // flatten all segments into one line (good enough for tracks)
        const flat = c.flat();
        return flat
          .filter(p => Array.isArray(p) && p.length >= 2)
          .map(p => [Number(p[1]), Number(p[0])]);
      }

      // If you ever store Polygon etc., add handling here
      return [];
    }

    fetch(detailUrl)
      .then(r => {
        if (!r.ok) throw new Error(`Failed to load GeoJSON: ${detailUrl} (${r.status})`);
        return r.json();
      })
      .then(gj => {
        const feature = pickFeature(gj);
        if (!feature || !feature.geometry) {
          throw new Error("Detail GeoJSON must be a Feature or FeatureCollection with geometry");
        }

        const latlngs = coordsToLatLngs(feature.geometry);
        if (latlngs.length < 2) {
          throw new Error(`Not enough coordinates to draw a track (got ${latlngs.length})`);
        }

        const line = L.polyline(latlngs, { weight: 4, opacity: 0.9 }).addTo(map);
        map.fitBounds(line.getBounds().pad(0.18));

        // Start/end markers
        L.circleMarker(latlngs[0], { radius: 6, opacity: 1, fillOpacity: 0.9 })
          .addTo(map).bindTooltip("Start");

        L.circleMarker(latlngs[latlngs.length - 1], { radius: 6, opacity: 1, fillOpacity: 0.9 })
          .addTo(map).bindTooltip("End");
      })
      .catch(err => {
        console.error(err);
      });
  </script>
</body>
</html>
