<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ginpeak • Touring Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/book.css" />
  <link rel="stylesheet" href="../css/map.css" />
  <link rel="stylesheet" href="../css/tour.css" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    /* keep map full width; height is primarily controlled by tour.css (#map) */
    #map{
      width:100%;
      height:420px;
      border-radius: 12px;
      overflow:hidden;
    }

    /* nav layout: left / center / right */
    .tour-nav{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap: 12px;
    }
    .tour-nav .nav-left{ justify-self:start; }
    .tour-nav .nav-center{ justify-self:center; text-align:center; }
    .tour-nav .nav-right{ justify-self:end; }

    /* center title + subline */
    .nav-title{
      font-weight: 800;
      font-size: clamp(18px, 2.2vw, 28px);
      line-height: 1.1;
    }
    .nav-sub{
      margin-top: 2px;
      font-size: 13px;
      opacity: 0.85;
    }

    /* buttons: border hugs text */
    .tour-nav a{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: fit-content;
      padding: 6px 10px;
      line-height: 1.2;
      border-radius: 10px;
      text-decoration:none;
    }

    /* error box */
    .map-error{
      margin-top:10px;
      padding:10px 12px;
      border:2px solid rgba(0,0,0,0.25);
      border-radius:10px;
      font-size:0.95rem;
      background: rgba(255, 235, 235, 0.95);
      display:none;
    }
    .map-error code { font-size: 0.9em; }

    /* small map UI bar above map */
    .map-tools{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
    }
    .map-tools .tool-left{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      font-size: 0.95rem;
      opacity: 0.95;
    }
    .toggle input{
      transform: translateY(1px);
    }

    @media (max-width: 900px){
      #map{ height: 320px; }
    }
  </style>
</head>

<body>
  <main class="tour-wrap">

    <nav class="tour-nav">
      <div class="nav-left">
        <a href="../guide.html">← Back to guide</a>
      </div>

      <div class="nav-center">
        <div class="nav-title">Ginpeak</div>
        <div class="nav-sub">British Columbia • Whistler</div>
      </div>

      <div class="nav-right">
        <a href="../tracks/Ginpeak_CAN_BC_Whistler_up.gpx" download class="btn">Download GPX</a>
      </div>
    </nav>

    <!-- MAP -->
    <section class="tour-map">

      <!-- lightweight controls ABOVE the map -->
      <div class="map-tools">
        <div class="tool-left">
          <label class="toggle" title="Relief shading overlay (terrain gradient look)">
            <input id="toggleHillshade" type="checkbox" checked />
            Terrain shading
          </label>

          <label class="toggle" title="Enable 3D terrain (pitch the map to see it)">
            <input id="toggle3D" type="checkbox" checked />
            3D terrain
          </label>
        </div>
      </div>

      <div id="map"></div>
      <div id="mapError" class="map-error"></div>
    </section>

    <!-- CONTENT -->
    <section class="tour-content">
      <h1>Overview</h1>
<p>This file is auto-generated and no information for this given.</p>
<h2>Quick facts</h2>
<ul>
<li><strong>Parking:</strong> This file is auto-generated and no information for this given.</li>
<li><strong>Start / trailhead:</strong> This file is auto-generated and no information for this given.</li>
<li><strong>Best season:</strong> This file is auto-generated and no information for this given.</li>
</ul>
<h1>Access</h1>
<p>This file is auto-generated and no information for this given.</p>
<h1>Route</h1>
<h2>Ascent</h2>
<p>This file is auto-generated and no information for this given.</p>
<h2>Descent</h2>
<p>This file is auto-generated and no information for this given.</p>
<h1>Avalanche terrain &amp; hazards</h1>
<ul>
<li><strong>Avalanche problems to watch:</strong> No information available — this file is generated automatically.</li>
<li><strong>Terrain traps:</strong> This file is auto-generated and no information for this given.</li>
</ul>
<h1>Conditions &amp; timing</h1>
<ul>
<li>This file is auto-generated and no information for this given.</li>
</ul>
<h1>Variants</h1>
<ul>
<li>This file is auto-generated and no information for this given.</li>
</ul>
<h1>Photos</h1>
<ul>
<li>This file is auto-generated and no information for this given.</li>
</ul>
<h1>References / links</h1>
<ul>
<li><a href="https://avalanche.ca/">Avalanche Canada</a></li>
<li><a href="https://snowpack.avalanche.ca/ca?center=-115%2C55&amp;zoom=4.25&amp;property=haz&amp;mapDataMode=zoom-based">Snowpackmodel Avalanche Canada</a></li>
</ul>
<p>---</p>
<p><strong>Disclaimer:</strong> This is a personal route note, not a guarantee of safety. Always assess current conditions and consult the avalanche bulletin.</p>
    </section>

  </main>

  <!-- Token: from docs/tours/*.html -> ../js/mapbox_token.js -->
  <script src="../js/mapbox_token.js"></script>

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.js"></script>

  <script>
    const token = window.MAPBOX_TOKEN; // mapbox_token.js must set window.MAPBOX_TOKEN = "pk..."
    const slug = "Ginpeak_CAN_BC_Whistler_up";
    const detailUrl = `../data/tours_detail/${slug}.geojson`;

    // match your guide.html settings if you want
    const MAP_STYLE = "mapbox://styles/mapbox/outdoors-v12";

    // DEM settings
    // For hillshade + 3D, a raster-dem source is required. :contentReference[oaicite:2]{index=2}
    const DEM_SOURCE_URL = "mapbox://mapbox.mapbox-terrain-dem-v1"; // common DEM tileset :contentReference[oaicite:3]{index=3}
    const TERRAIN_EXAGGERATION = 1.25;

    function htmlEscape(s) {
      return String(s)
        .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    function showError(msg, obj) {
      console.error(msg, obj || "");
      const el = document.getElementById("mapError");
      if (!el) return;
      el.style.display = "block";
      const extra = obj
        ? `<br><code>${htmlEscape(JSON.stringify(obj).slice(0, 900))}${JSON.stringify(obj).length > 900 ? "…" : ""}</code>`
        : "";
      el.innerHTML = `<strong>Map error:</strong> ${htmlEscape(msg)}${extra}`;
    }

    if (!token) {
      showError("MAPBOX_TOKEN not found. Check ../js/mapbox_token.js sets window.MAPBOX_TOKEN = 'pk...';");
    }
    mapboxgl.accessToken = token || "";

    // GeoJSON helpers
    function extractFirstLineCoords(gj) {
      let geom = null;
      if (gj?.type === "FeatureCollection" && gj.features?.length) geom = gj.features[0]?.geometry;
      else if (gj?.type === "Feature") geom = gj.geometry;
      else if (gj?.geometry) geom = gj.geometry;
      else geom = gj;

      const coords = geom?.coordinates;
      if (!coords) return null;

      const pts = Array.isArray(coords[0]?.[0]) ? coords.flat() : coords;
      return pts
        .filter(p => Array.isArray(p) && p.length >= 2)
        .map(p => [Number(p[0]), Number(p[1])]);
    }

    // Map init
    const map = new mapboxgl.Map({
      container: "map",
      style: MAP_STYLE,
      center: [-123.0, 50.0],
      zoom: 7,
      pitch: 55,
      bearing: -15,
      antialias: true
    });

    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), "top-right");

    // --- Terrain / hillshade wiring ---
    const DEM_SOURCE_ID = "mapbox-dem";
    const HILLSHADE_LAYER_ID = "terrain-hillshade";

    function ensureDemSource() {
      if (map.getSource(DEM_SOURCE_ID)) return;

      map.addSource(DEM_SOURCE_ID, {
        type: "raster-dem",
        url: DEM_SOURCE_URL,
        tileSize: 512,
        maxzoom: 14
      });
    }

    function set3DTerrain(enabled) {
      ensureDemSource();
      if (enabled) {
        map.setTerrain({ source: DEM_SOURCE_ID, exaggeration: TERRAIN_EXAGGERATION });
        // optional sky for nicer look
        if (!map.getLayer("sky")) {
          map.addLayer({
            id: "sky",
            type: "sky",
            paint: {
              "sky-type": "atmosphere",
              "sky-atmosphere-sun": [0.0, 0.0],
              "sky-atmosphere-sun-intensity": 12
            }
          });
        }
      } else {
        map.setTerrain(null);
      }
    }

    function setHillshade(enabled) {
      ensureDemSource();

      if (!map.getLayer(HILLSHADE_LAYER_ID)) {
        // Insert hillshade low in the stack so it behaves like a basemap overlay
        // If you want it ABOVE certain layers, adjust beforeId.
        map.addLayer({
          id: HILLSHADE_LAYER_ID,
          type: "hillshade",
          source: DEM_SOURCE_ID,
          layout: { visibility: enabled ? "visible" : "none" },
          paint: {
            // tune these to taste (this is what creates the “gradient/relief” feel)
            "hillshade-exaggeration": 0.6,
            "hillshade-shadow-color": "rgba(0,0,0,0.35)",
            "hillshade-highlight-color": "rgba(255,255,255,0.55)",
            "hillshade-accent-color": "rgba(110,110,110,0.35)"
          }
        });
      } else {
        map.setLayoutProperty(HILLSHADE_LAYER_ID, "visibility", enabled ? "visible" : "none");
      }
    }

    // UI toggles
    function wireToggles() {
      const hillshadeCb = document.getElementById("toggleHillshade");
      const terrainCb = document.getElementById("toggle3D");
      if (!hillshadeCb || !terrainCb) return;

      hillshadeCb.addEventListener("change", () => {
        try { setHillshade(!!hillshadeCb.checked); } catch (e) { showError(String(e)); }
      });

      terrainCb.addEventListener("change", () => {
        try { set3DTerrain(!!terrainCb.checked); } catch (e) { showError(String(e)); }
      });
    }

    // Load data + draw tour
    fetch(detailUrl)
      .then(r => {
        if (!r.ok) throw new Error(`Failed to load GeoJSON (${r.status})`);
        return r.json();
      })
      .then(gj => {
        const lineCoords = extractFirstLineCoords(gj);
        if (!lineCoords || lineCoords.length < 2) throw new Error("Not enough coordinates to draw.");

        map.on("load", () => {
          // enable both by default
          setHillshade(true);
          set3DTerrain(true);
          wireToggles();

          map.addSource("tour", {
            type: "geojson",
            data: { type: "Feature", geometry: { type: "LineString", coordinates: lineCoords } }
          });

          map.addLayer({
            id: "tour-line",
            type: "line",
            source: "tour",
            paint: { "line-color": "#111", "line-width": 4, "line-opacity": 0.95 }
          });

          map.addSource("start", {
            type: "geojson",
            data: { type: "Feature", geometry: { type: "Point", coordinates: lineCoords[0] } }
          });
          map.addLayer({
            id: "start-pt",
            type: "circle",
            source: "start",
            paint: {
              "circle-radius": 6,
              "circle-color": "#111",
              "circle-stroke-width": 2,
              "circle-stroke-color": "#fff"
            }
          });

          map.addSource("end", {
            type: "geojson",
            data: { type: "Feature", geometry: { type: "Point", coordinates: lineCoords[lineCoords.length - 1] } }
          });
          map.addLayer({
            id: "end-pt",
            type: "circle",
            source: "end",
            paint: {
              "circle-radius": 6,
              "circle-color": "#111",
              "circle-stroke-width": 2,
              "circle-stroke-color": "#fff",
              "circle-opacity": 0.85
            }
          });

          const bounds = lineCoords.reduce(
            (b, c) => b.extend(c),
            new mapboxgl.LngLatBounds(lineCoords[0], lineCoords[0])
          );
          map.fitBounds(bounds, { padding: 60, duration: 0 });
        });
      })
      .catch(err => showError(err.message || String(err)));
  </script>
</body>
</html>
