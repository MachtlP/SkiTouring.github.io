<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Nevetraverse • Touring Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/book.css" />
  <link rel="stylesheet" href="../css/map.css" />
  <link rel="stylesheet" href="../css/tour.css" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    /* 4) map full width under header */
    #map {
      width: 100%;
      height: 420px;
      border-radius: 12px;
      overflow: hidden;
    }

    /* 2) nav: left / center / right */
    .tour-nav {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .tour-nav .nav-left { justify-self: start; }
    .tour-nav .nav-center { justify-self: center; }
    .tour-nav .nav-right { justify-self: end; }

    /* 3) buttons: border hugs text (no full-width) */
    .tour-nav a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: fit-content;
      padding: 6px 10px;
      line-height: 1.2;
      border-radius: 10px;
      text-decoration: none;
    }

    /* make sure the "btn" class doesn't force big padding/width */
    .tour-nav a.btn {
      width: fit-content;
      padding: 6px 10px;
    }

    /* header centered below nav */
    .tour-header {
      text-align: center;
      margin: 6px 0 12px;
    }

    /* optional: keep content spacing neat */
    .tour-map { margin-bottom: 14px; }

    /* simple error box */
    .map-error{
      margin-top:10px;
      padding:10px 12px;
      border:2px solid rgba(0,0,0,0.25);
      border-radius:10px;
      font-size:0.95rem;
      background: rgba(255, 235, 235, 0.95);
      display:none;
    }
    .map-error code { font-size: 0.9em; }
  </style>
</head>

<body>
  <main class="tour-wrap">

    <!-- 2) nav layout -->
   <nav class="tour-nav">
  <div class="nav-left"><a href="../guide.html">← Back to guide</a></div>
  <div class="nav-center">
  <div class="nav-title">Nevetraverse</div>
  <div class="nav-sub">British Columbia • Garibaldi</div>
</div>

  <div class="nav-right"><a href="../tracks/NeveTraverse_CAN_BC_Garibaldi_traverse.gpx" download class="btn">Download GPX</a></div>
</nav>


    <!-- 4) below header full-width map -->
    <section class="tour-map">
      <div id="map"></div>
      <div id="mapError" class="map-error"></div>
    </section>

    <!-- 5) below map: tour content -->
    <section class="tour-content">
      <h1>Overview</h1>
<p>This file is auto-generated and no information for this given.</p>
<h2>Quick facts</h2>
<ul>
<li><strong>Parking:</strong> This file is auto-generated and no information for this given.</li>
<li><strong>Start / trailhead:</strong> This file is auto-generated and no information for this given.</li>
<li><strong>Best season:</strong> This file is auto-generated and no information for this given.</li>
</ul>
<h1>Access</h1>
<p>This file is auto-generated and no information for this given.</p>
<h1>Route</h1>
<h2>Ascent</h2>
<p>This file is auto-generated and no information for this given.</p>
<h2>Descent</h2>
<p>This file is auto-generated and no information for this given.</p>
<h1>Avalanche terrain &amp; hazards</h1>
<ul>
<li><strong>Avalanche problems to watch:</strong> No information available — this file is generated automatically.</li>
<li><strong>Terrain traps:</strong> This file is auto-generated and no information for this given.</li>
</ul>
<h1>Conditions &amp; timing</h1>
<ul>
<li>This file is auto-generated and no information for this given.</li>
</ul>
<h1>Variants</h1>
<ul>
<li>This file is auto-generated and no information for this given.</li>
</ul>
<h1>Photos</h1>
<ul>
<li>This file is auto-generated and no information for this given.</li>
</ul>
<h1>References / links</h1>
<ul>
<li><a href="https://avalanche.ca/">Avalanche Canada</a></li>
<li><a href="https://snowpack.avalanche.ca/ca?center=-115%2C55&amp;zoom=4.25&amp;property=haz&amp;mapDataMode=zoom-based">Snowpackmodel Avalanche Canada</a></li>
</ul>
<p>---</p>
<p><strong>Disclaimer:</strong> This is a personal route note, not a guarantee of safety. Always assess current conditions and consult the avalanche bulletin.</p>
    </section>

  </main>

  <!-- IMPORTANT: token file path from tours/*.html -->
  <script src="../js/mapbox_token.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.js"></script>

  <script>
    // ==========================
    // Minimal Mapbox setup
    // ==========================
    const token = window.MAPBOX_TOKEN; // mapbox_token.js must set this
    const slug = "NeveTraverse_CAN_BC_Garibaldi_traverse";
    const detailUrl = `../data/tours_detail/${slug}.geojson`;

    function showError(msg, obj) {
      console.error(msg, obj || "");
      const el = document.getElementById("mapError");
      if (!el) return;
      el.style.display = "block";
      const extra = obj ? `<br><code>${String(JSON.stringify(obj)).slice(0, 800)}${JSON.stringify(obj).length > 800 ? "…" : ""}</code>` : "";
      el.innerHTML = `<strong>Map error:</strong> ${msg}${extra}`;
    }

    if (!token) {
      showError("MAPBOX_TOKEN not found. Check sets window.MAPBOX_TOKEN = 'pk...';");
    }
    mapboxgl.accessToken = token || "";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/outdoors-v12",
      center: [-123.0, 50.0],
      zoom: 7
    });

    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), "top-right");

    // Load tour line and fit bounds
    fetch(detailUrl)
      .then(r => {
        if (!r.ok) throw new Error(`Failed to load GeoJSON (${r.status})`);
        return r.json();
      })
      .then(gj => {
        // get first geometry
        let geom = null;
        if (gj?.type === "FeatureCollection" && gj.features?.length) geom = gj.features[0]?.geometry;
        else if (gj?.type === "Feature") geom = gj.geometry;
        else if (gj?.geometry) geom = gj.geometry;
        else geom = gj;

        const coords = geom?.coordinates;
        if (!coords) throw new Error("No geometry.coordinates found in GeoJSON");

        // flatten coords (LineString or MultiLineString)
        const pts = Array.isArray(coords[0][0]) ? coords.flat() : coords; // crude but works for LineString/MultiLineString
        const lineCoords = pts.map(p => [Number(p[0]), Number(p[1])]).filter(p => isFinite(p[0]) && isFinite(p[1]));

        if (lineCoords.length < 2) throw new Error(`Not enough coordinates to draw (${lineCoords.length})`);

        map.on("load", () => {
          map.addSource("tour", {
            type: "geojson",
            data: {
              type: "Feature",
              geometry: { type: "LineString", coordinates: lineCoords }
            }
          });

          map.addLayer({
            id: "tour-line",
            type: "line",
            source: "tour",
            paint: {
              "line-color": "#111",
              "line-width": 4,
              "line-opacity": 0.95
            }
          });

          // start + end points
          map.addSource("start", {
            type: "geojson",
            data: { type: "Feature", geometry: { type: "Point", coordinates: lineCoords[0] } }
          });
          map.addLayer({
            id: "start-pt",
            type: "circle",
            source: "start",
            paint: {
              "circle-radius": 6,
              "circle-color": "#111",
              "circle-stroke-width": 2,
              "circle-stroke-color": "#fff"
            }
          });

          map.addSource("end", {
            type: "geojson",
            data: { type: "Feature", geometry: { type: "Point", coordinates: lineCoords[lineCoords.length - 1] } }
          });
          map.addLayer({
            id: "end-pt",
            type: "circle",
            source: "end",
            paint: {
              "circle-radius": 6,
              "circle-color": "#111",
              "circle-stroke-width": 2,
              "circle-stroke-color": "#fff",
              "circle-opacity": 0.8
            }
          });

          // fit bounds
          const bounds = lineCoords.reduce(
            (b, c) => b.extend(c),
            new mapboxgl.LngLatBounds(lineCoords[0], lineCoords[0])
          );
          map.fitBounds(bounds, { padding: 60, duration: 0 });
        });
      })
      .catch(err => showError(err.message || String(err)));
  </script>
</body>
</html>
