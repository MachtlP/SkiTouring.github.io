<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ski Touring Guide GPX tracks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet (keep, but only one basemap layer is used) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Your styles -->
  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/hero.css" />
  <link rel="stylesheet" href="./css/book.css" />
  <link rel="stylesheet" href="./css/map.css" />
</head>

<body>
  <!-- Cover-page hero -->
  <section class="hero hero--guide" aria-label="Guidebook intro">
    <div class="hero-media">
      <img src="./assets/cover.jpg" alt="Touring Guide Cover" loading="lazy" decoding="async">
    </div>

    <div class="hero-inner">
      <div class="hero-badge">
        <span class="dot"></span>
        <span>Ski Touring Guide</span>
        <span class="sep">•</span>
        <span>Winter 2025/26</span>
      </div>

      <h2 class="hero-title">Ski Touring Guide</h2>
      <p class="hero-sub">
        This map-linked ski touring guide brings together GPX tracks, photos, and practical notes in one place.
        I created it after finding it surprisingly difficult to locate concise, route-specific GPX information without endlessly scrolling through scattered trip reports.
        These routes reflect personal experiences and are not guaranteed to represent the best or safest approach under all conditions.
        Cheers Machtl
        <br><br>
        <b>Always assess current local conditions and consult the avalanche forecast before heading out.</b>
      </p>

      <div class="hero-cta">
        <button class="hero-btn primary" id="ctaBrowse" type="button">Browse the book</button>
        <button class="hero-btn" id="ctaMap" type="button">Jump to map</button>
      </div>
    </div>
  </section>

  <!-- Header / filters -->
  <header>
    <div class="topbar">
      <div class="brand">
        <h1>Ski Touring Guide</h1>
        <p>Scan the book • click the map • open tours in a new tab</p>
      </div>

      <div class="controls">
        <input id="q" placeholder="Search title / region…" />
        <select id="province">
          <option value="">All provinces</option>
        </select>

        <select id="region">
          <option value="">All regions</option>
        </select>

        <button id="fit" type="button">Fit map to results</button>
      </div>
    </div>
  </header>

  <!-- Main split -->
  <main>
    <section class="book">
      <div class="bookhead">
        <div><strong>Guidebook</strong></div>
        <div class="count" id="count">Loading…</div>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <section class="mapwrap" id="map-section">
      <div class="maphead">
        <div><strong>Map</strong></div>
        <div class="count">Click a line → open tour</div>
      </div>
      <div id="map"></div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ==========================
    // FAST GUIDE MAP (OSM only)
    // - fixes basemap init order
    // - removes layer switcher
    // - canvas renderer for speed
    // - no point markers (lines only)
    // - loads GeoJSON after first paint
    // ==========================

    const GEOJSON_URL = "./data/tours.geojson";

    // ---- Direction → color ----
    function trackColorFromDirection(direction) {
      const d = String(direction || "").toLowerCase().trim();
      if (d === "up" || d === "ascent") return "#1f6feb";       // blue
      if (d === "down" || d === "descent") return "#b64a4a";    // calm red
      if (d === "traverse" || d === "cross") return "#b000b5";  // magenta
      return "#1f6feb";
    }

    // ---- Basemap (OpenStreetMap only) ----
    const openStreet = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      { maxZoom: 19, attribution: "&copy; OpenStreetMap contributors" }
    );

    const map = L.map("map", {
      zoomControl: true,
      preferCanvas: true,
      renderer: L.canvas(),
      layers: [openStreet]
    });

    // quick fallback (replaced by fitBounds once tours load)
    map.setView([50.0, -123.0], 7);

    // ---- Load overview GeoJSON (deferred) ----
    let toursLayer = null;

    function showLoadError(err) {
      console.error(err);
      alert("Could not load tours.geojson. Check console for details.");
    }

    function loadTours() {
      fetch(GEOJSON_URL, { cache: "force-cache" })
        .then(r => {
          if (!r.ok) throw new Error(`Failed to load ${GEOJSON_URL} (${r.status})`);
          return r.json();
        })
        .then(gj => {
          toursLayer = L.geoJSON(gj, {
            // Lines only (no point markers) for speed
            style: (feature) => {
              const p = feature?.properties || {};
              const dir = p.direction || p.direcrtion || "";
              return {
                color: trackColorFromDirection(dir),
                weight: 3,
                opacity: 0.95
              };
            },
            onEachFeature: (feature, layer) => {
              const p = feature?.properties || {};
              const page = p.page || p.url || "";

              if (page) {
                layer.on("click", () => window.open(page, "_blank"));
              }

              const title = p.title || p.slug || "Tour";
              const dir = p.direction || p.direcrtion || "";
              layer.bindTooltip(`${title}${dir ? " • " + dir : ""}`, { sticky: true });
            }
          }).addTo(map);

          // Fit to all tours
          try {
            const b = toursLayer.getBounds();
            if (b.isValid()) map.fitBounds(b.pad(0.15));
          } catch (_) {}
        })
        .catch(showLoadError);
    }

    // Defer heavy work so UI renders instantly
    if ("requestIdleCallback" in window) {
      requestIdleCallback(loadTours, { timeout: 1200 });
    } else {
      setTimeout(loadTours, 50);
    }

    // ---- Fit button ----
    document.getElementById("fit")?.addEventListener("click", () => {
      if (!toursLayer) return;
      const b = toursLayer.getBounds();
      if (b.isValid()) map.fitBounds(b.pad(0.15));
    });

    // ---- Hero buttons ----
    document.getElementById("ctaMap")?.addEventListener("click", () => {
      document.getElementById("map-section")?.scrollIntoView({ behavior: "smooth" });
      setTimeout(() => map.invalidateSize(), 350);
    });

    document.getElementById("ctaBrowse")?.addEventListener("click", () => {
      document.querySelector(".book")?.scrollIntoView({ behavior: "smooth" });
    });
  </script>
</body>
</html>
