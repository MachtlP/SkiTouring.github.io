<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{TITLE}} • Touring Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/book.css" />
  <link rel="stylesheet" href="../css/map.css" />
  <link rel="stylesheet" href="../css/tour.css" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    /* Map full width under nav */
    #map{
      width: 100%;
      height: 420px;
      border-radius: 12px;
      overflow: hidden;
    }

    /* Nav: left / center / right */
    .tour-nav{
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .tour-nav .nav-left  { justify-self: start; }
    .tour-nav .nav-center{ justify-self: center; text-align: center; }
    .tour-nav .nav-right { justify-self: end; }

    /* Center title + subline */
    .nav-title{
      font-weight: 800;
      font-size: clamp(18px, 2.2vw, 28px);
      line-height: 1.1;
    }
    .nav-sub{
      margin-top: 2px;
      font-size: 13px;
      opacity: 0.85;
      line-height: 1.2;
      white-space: nowrap;
    }

    /* Buttons: border hugs text */
    .tour-nav a{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: fit-content;
      padding: 6px 10px;
      line-height: 1.2;
      border-radius: 10px;
      text-decoration: none;
    }
    .tour-nav a.btn{
      width: fit-content;
      padding: 6px 10px;
    }

    /* Optional spacing */
    .tour-map{ margin-bottom: 14px; }

    /* Error box */
    .map-error{
      margin-top:10px;
      padding:10px 12px;
      border:2px solid rgba(0,0,0,0.25);
      border-radius:10px;
      font-size:0.95rem;
      background: rgba(255, 235, 235, 0.95);
      display:none;
    }
    .map-error code { font-size: 0.9em; }
  </style>
</head>

<body>
  <main class="tour-wrap">

    <nav class="tour-nav">
      <div class="nav-left">
        <a href="../guide.html">← Back to guide</a>
      </div>

      <div class="nav-center">
        <div class="nav-title">{{TITLE}}</div>
        <div class="nav-sub">{{PROVINCE}} • {{REGION}}</div>
      </div>

      <div class="nav-right">
        <a href="{{GPX_URL}}" download class="btn">Download GPX</a>
      </div>
    </nav>

    <section class="tour-map">
      <div id="map"></div>
      <div id="mapError" class="map-error"></div>
    </section>

    <section class="tour-content">
      {{CONTENT_HTML}}
    </section>

  </main>

  <!-- Token path from docs/tours/*.html -->
  <script src="../js/mapbox_token.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.js"></script>

  <script>
    // ==========================
    // Mapbox 3D terrain tour map
    // ==========================
    const token = window.MAPBOX_TOKEN; // mapbox_token.js must set this
    const slug = "{{SLUG}}";
    const detailUrl = `../data/tours_detail/${slug}.geojson`;

    function showError(msg, obj) {
      console.error(msg, obj || "");
      const el = document.getElementById("mapError");
      if (!el) return;
      el.style.display = "block";
      const extra = obj
        ? `<br><code>${String(JSON.stringify(obj)).slice(0, 800)}${
            JSON.stringify(obj).length > 800 ? "…" : ""
          }</code>`
        : "";
      el.innerHTML = `<strong>Map error:</strong> ${msg}${extra}`;
    }

    if (!token) {
      showError("MAPBOX_TOKEN not found. Check ../js/mapbox_token.js sets window.MAPBOX_TOKEN = 'pk...';");
    }
    mapboxgl.accessToken = token || "";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/outdoors-v12",
      center: [-123.0, 50.0],
      zoom: 7,
      pitch: 60,
      bearing: -20,
      antialias: true
    });

    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), "top-right");

    map.on("load", async () => {
      try {
        // ---- 3D terrain ----
        map.addSource("mapbox-dem", {
          type: "raster-dem",
          url: "mapbox://mapbox.terrain-rgb",
          tileSize: 512,
          maxzoom: 14
        });

        map.setTerrain({ source: "mapbox-dem", exaggeration: 1.2 });

        // Optional: sky layer (nice in 3D)
        map.addLayer({
          id: "sky",
          type: "sky",
          paint: {
            "sky-type": "atmosphere",
            "sky-atmosphere-sun-intensity": 10
          }
        });

        // ---- Load tour geometry ----
        const gj = await fetch(detailUrl, { cache: "force-cache" }).then(r => {
          if (!r.ok) throw new Error(`Failed to load GeoJSON (${r.status})`);
          return r.json();
        });

        // get first geometry
        let geom = null;
        if (gj?.type === "FeatureCollection" && gj.features?.length) geom = gj.features[0]?.geometry;
        else if (gj?.type === "Feature") geom = gj.geometry;
        else if (gj?.geometry) geom = gj.geometry;
        else geom = gj;

        const coords = geom?.coordinates;
        if (!coords) throw new Error("No geometry.coordinates found in GeoJSON");

        // flatten coords (LineString or MultiLineString)
        const pts = Array.isArray(coords[0]?.[0]) ? coords.flat() : coords;
        const lineCoords = pts
          .map(p => [Number(p[0]), Number(p[1])])
          .filter(p => isFinite(p[0]) && isFinite(p[1]));

        if (lineCoords.length < 2) throw new Error(`Not enough coordinates to draw (${lineCoords.length})`);

        // ---- Draw line ----
        map.addSource("tour", {
          type: "geojson",
          data: { type: "Feature", geometry: { type: "LineString", coordinates: lineCoords } }
        });

        map.addLayer({
          id: "tour-line",
          type: "line",
          source: "tour",
          layout: { "line-join": "round", "line-cap": "round" },
          paint: { "line-color": "#111", "line-width": 4, "line-opacity": 0.95 }
        });

        // start point
        map.addSource("start", {
          type: "geojson",
          data: { type: "Feature", geometry: { type: "Point", coordinates: lineCoords[0] } }
        });
        map.addLayer({
          id: "start-pt",
          type: "circle",
          source: "start",
          paint: {
            "circle-radius": 6,
            "circle-color": "#111",
            "circle-stroke-width": 2,
            "circle-stroke-color": "#fff"
          }
        });

        // end point
        map.addSource("end", {
          type: "geojson",
          data: { type: "Feature", geometry: { type: "Point", coordinates: lineCoords[lineCoords.length - 1] } }
        });
        map.addLayer({
          id: "end-pt",
          type: "circle",
          source: "end",
          paint: {
            "circle-radius": 6,
            "circle-color": "#111",
            "circle-stroke-width": 2,
            "circle-stroke-color": "#fff",
            "circle-opacity": 0.8
          }
        });

        // ---- Fit bounds ----
        const bounds = lineCoords.reduce(
          (b, c) => b.extend(c),
          new mapboxgl.LngLatBounds(lineCoords[0], lineCoords[0])
        );
        map.fitBounds(bounds, { padding: 60, duration: 0 });

      } catch (err) {
        showError(err?.message || String(err));
      }
    });
  </script>
</body>
</html>
