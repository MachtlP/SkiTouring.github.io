<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{TITLE}} • Touring Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/book.css" />
  <link rel="stylesheet" href="../css/map.css" />
  <link rel="stylesheet" href="../css/tour.css" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    #map { height: 420px; width: 100%; border-radius: 12px; }
  </style>
</head>

<body>
  <main class="tour-wrap">

    <nav class="tour-nav">
      <a href="../guide.html">← Back to guide</a>
      <a href="{{GPX_URL}}" download class="btn">Download GPX</a>
    </nav>

    <header class="tour-header">
      <h1 class="tour-title">{{TITLE}}</h1>
      <p class="tour-sub">{{PROVINCE}} • {{REGION}}</p>
    </header>

    <section class="tour-map">
      <div id="map"></div>
    </section>

    <section class="tour-content">
      {{CONTENT_HTML}}
    </section>

  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const slug = "{{SLUG}}";
    const detailUrl = `../data/tours_detail/${slug}.geojson`;

    const map = L.map("map", { zoomControl: true });

    // --- Base layers ---
    const openTopo = L.tileLayer(
      "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 17,
        attribution: "&copy; OpenStreetMap contributors, SRTM | OpenTopoMap"
      }
    );

    const openStreet = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }
    );

    // Default basemap
    openTopo.addTo(map);

    // Layer control
    L.control.layers(
      { "Topo": openTopo, "Street": openStreet },
      null,
      { collapsed: true }
    ).addTo(map);

    // Fallback view (only used if loading fails)
    map.setView([50.0, -123.0], 7);

    function pickFeature(gj) {
      if (!gj || typeof gj !== "object") return null;
      if (gj.type === "Feature") return gj;
      if (gj.type === "FeatureCollection" && Array.isArray(gj.features) && gj.features.length) {
        return gj.features[0];
      }
      return null;
    }

    function coordsToLatLngs(geometry) {
      // Supports LineString and MultiLineString
      const t = geometry?.type;
      const c = geometry?.coordinates;

      if (!t || !c) return [];

      if (t === "LineString") {
        return c
          .filter(p => Array.isArray(p) && p.length >= 2)
          .map(p => [Number(p[1]), Number(p[0])]); // [lat, lon]
      }

      if (t === "MultiLineString") {
        // flatten all segments into one line (good enough for tracks)
        const flat = c.flat();
        return flat
          .filter(p => Array.isArray(p) && p.length >= 2)
          .map(p => [Number(p[1]), Number(p[0])]);
      }

      // If you ever store Polygon etc., add handling here
      return [];
    }

    fetch(detailUrl)
      .then(r => {
        if (!r.ok) throw new Error(`Failed to load GeoJSON: ${detailUrl} (${r.status})`);
        return r.json();
      })
      .then(gj => {
        const feature = pickFeature(gj);
        if (!feature || !feature.geometry) {
          throw new Error("Detail GeoJSON must be a Feature or FeatureCollection with geometry");
        }

        const latlngs = coordsToLatLngs(feature.geometry);
        if (latlngs.length < 2) {
          throw new Error(`Not enough coordinates to draw a track (got ${latlngs.length})`);
        }

        const line = L.polyline(latlngs, { weight: 4, opacity: 0.9 }).addTo(map);
        map.fitBounds(line.getBounds().pad(0.18));

        // Start/end markers
        L.circleMarker(latlngs[0], { radius: 6, opacity: 1, fillOpacity: 0.9 })
          .addTo(map).bindTooltip("Start");

        L.circleMarker(latlngs[latlngs.length - 1], { radius: 6, opacity: 1, fillOpacity: 0.9 })
          .addTo(map).bindTooltip("End");
      })
      .catch(err => {
        console.error(err);
      });
  </script>
</body>
</html>
