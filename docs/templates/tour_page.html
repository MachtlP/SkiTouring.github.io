<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>{{TITLE}} • Touring Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/book.css" />
  <link rel="stylesheet" href="../css/map.css" />
  <link rel="stylesheet" href="../css/tour.css" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    /* keep map full width; height is primarily controlled by tour.css (#map) */
    #map{
      width:100%;
      height:420px;
      border-radius: 12px;
      overflow:hidden;
    }

    /* nav layout: left / center / right */
    .tour-nav{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap: 12px;
    }
    .tour-nav .nav-left{ justify-self:start; }
    .tour-nav .nav-center{ justify-self:center; text-align:center; }
    .tour-nav .nav-right{ justify-self:end; }

    /* center title + subline */
    .nav-title{
      font-weight: 800;
      font-size: clamp(18px, 2.2vw, 28px);
      line-height: 1.1;
    }
    .nav-sub{
      margin-top: 2px;
      font-size: 13px;
      opacity: 0.85;
    }

    /* buttons: border hugs text */
    .tour-nav a{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width: fit-content;
      padding: 6px 10px;
      line-height: 1.2;
      border-radius: 10px;
      text-decoration:none;
    }

    /* Map controls row (toggle etc.) */
    .map-controls{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
    }
    .toggle{
      display:inline-flex;
      gap: 10px;
      align-items:center;
      user-select:none;
      font-size: 14px;
    }
    .toggle input{ transform: translateY(1px); }

    /* Error box */
    .map-error{
      margin-top:10px;
      padding:10px 12px;
      border:2px solid rgba(0,0,0,0.25);
      border-radius:10px;
      font-size:0.95rem;
      background: rgba(255, 235, 235, 0.95);
      display:none;
    }
    .map-error code { font-size: 0.9em; }

    /* Plotly elevation block */
    .elev-wrap{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow: hidden;
    }
    .elev-head{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 8px;
    }
    .elev-title{ font-weight: 800; }
    .elev-stats{ opacity: .9; font-size: .95rem; }
    #elevPlot{
      width: 100%;
      height: 240px;
    }
    #elevNote{
      display:none;
      opacity:.85;
      font-size:.95rem;
      margin-top: 8px;
    }

    @media (max-width: 900px){
      #map{ height: 320px; }
      #elevPlot{ height: 220px; }
      .map-controls{ padding: 8px 10px; }
    }
  </style>
</head>

<body>
  <main class="tour-wrap">

    <nav class="tour-nav">
      <div class="nav-left">
        <a href="../guide.html">← Back to guide</a>
      </div>

      <div class="nav-center">
        <div class="nav-title">{{TITLE}}</div>
        <div class="nav-sub">{{PROVINCE}} • {{REGION}}</div>
      </div>

      <div class="nav-right">
        <a href="{{GPX_URL}}" download class="btn">Download GPX</a>
      </div>
    </nav>

    <!-- MAP -->
    <section class="tour-map">
      <div class="map-controls">
        <label class="toggle" title="Toggle a line gradient overlay (distance-progress gradient)">
          <input id="toggleGradient" type="checkbox" />
          <span>Gradient overlay</span>
        </label>

        <!-- optional tiny hint -->
        <span style="opacity:.8;font-size:13px;">Tip: drag/scroll, pitch for 3D</span>
      </div>

      <div id="map"></div>
      <div id="mapError" class="map-error"></div>
    </section>

    <!-- Elevation profile (Plotly) -->
    <section class="elev-wrap">
      <div class="elev-head">
        <div class="elev-title">Elevation profile</div>
        <div class="elev-stats" id="elevStats">loading…</div>
      </div>
      <div id="elevPlot"></div>
      <div id="elevNote">No elevation data found in this GeoJSON.</div>
    </section>

    <!-- CONTENT -->
    <section class="tour-content">
      {{CONTENT_HTML}}
    </section>

  </main>

  <!-- Token: from docs/tours/*.html -> ../js/mapbox_token.js -->
  <script src="../js/mapbox_token.js"></script>

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.js"></script>

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <script>
    // ==========================
    // Config
    // ==========================
    const token = window.MAPBOX_TOKEN; // must set window.MAPBOX_TOKEN = "pk..."
    const slug = "{{SLUG}}";
    const detailUrl = `../data/tours_detail/${slug}.geojson`;

    // Match guide.html-ish setup
    const MAP_STYLE = "mapbox://styles/mapbox/outdoors-v12";
    const DEM_SOURCE = "mapbox://mapbox.terrain-rgb";
    const TERRAIN_EXAGGERATION = 1.25;

    function htmlEscape(s) {
      return String(s)
        .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    function showError(msg, obj) {
      console.error(msg, obj || "");
      const el = document.getElementById("mapError");
      if (!el) return;
      el.style.display = "block";
      const extra = obj
        ? `<br><code>${htmlEscape(JSON.stringify(obj).slice(0, 900))}${JSON.stringify(obj).length > 900 ? "…" : ""}</code>`
        : "";
      el.innerHTML = `<strong>Map error:</strong> ${htmlEscape(msg)}${extra}`;
    }

    if (!token) {
      showError("MAPBOX_TOKEN not found. Check ../js/mapbox_token.js sets window.MAPBOX_TOKEN = 'pk...';");
    }
    mapboxgl.accessToken = token || "";

    // ==========================
    // GeoJSON helpers
    // ==========================
    function extractFirstLineCoords(gj) {
      let geom = null;
      if (gj?.type === "FeatureCollection" && gj.features?.length) geom = gj.features[0]?.geometry;
      else if (gj?.type === "Feature") geom = gj.geometry;
      else if (gj?.geometry) geom = gj.geometry;
      else geom = gj;

      const coords = geom?.coordinates;
      if (!coords) return null;

      // LineString: [ [lon,lat,ele?], ... ]
      // MultiLineString: [ [ [lon,lat,ele?], ... ], ... ]
      const pts = Array.isArray(coords[0]?.[0]) ? coords.flat() : coords;
      return pts
        .filter(p => Array.isArray(p) && p.length >= 2)
        .map(p => [Number(p[0]), Number(p[1]), (p.length >= 3 ? Number(p[2]) : null)]);
    }

    function haversineMeters(lat1, lon1, lat2, lon2) {
      const R = 6371000, toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    // ==========================
    // Map init (3D terrain)
    // ==========================
    const map = new mapboxgl.Map({
      container: "map",
      style: MAP_STYLE,
      center: [-123.0, 50.0],
      zoom: 7,
      pitch: 55,
      bearing: -15,
      antialias: true
    });

    map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), "top-right");

    function enable3DTerrain() {
      if (!map.getSource("mapbox-dem")) {
        map.addSource("mapbox-dem", {
          type: "raster-dem",
          url: DEM_SOURCE,
          tileSize: 512,
          maxzoom: 14
        });
      }
      map.setTerrain({ source: "mapbox-dem", exaggeration: TERRAIN_EXAGGERATION });

      if (!map.getLayer("sky")) {
        map.addLayer({
          id: "sky",
          type: "sky",
          paint: {
            "sky-type": "atmosphere",
            "sky-atmosphere-sun": [0.0, 0.0],
            "sky-atmosphere-sun-intensity": 10
          }
        });
      }
    }

    // ==========================
    // Gradient overlay toggle
    // ==========================
    function setGradientVisible(visible) {
      const v = visible ? "visible" : "none";
      if (map.getLayer("tour-line-gradient")) {
        map.setLayoutProperty("tour-line-gradient", "visibility", v);
      }
      // (Optional) also dim the base line when gradient is on
      if (map.getLayer("tour-line")) {
        map.setPaintProperty("tour-line", "line-opacity", visible ? 0.10 : 0.95);
      }
    }

    document.getElementById("toggleGradient")?.addEventListener("change", (e) => {
      setGradientVisible(Boolean(e.target.checked));
    });

    // ==========================
    // Elevation plot (Plotly)
    // ==========================
    function renderElevationPlot(pointsLonLatEle) {
      const elevStatsEl = document.getElementById("elevStats");
      const elevNoteEl = document.getElementById("elevNote");

      const elev = pointsLonLatEle.map(p => (Number.isFinite(p[2]) ? p[2] : null));
      const hasElev = elev.some(v => v !== null);

      if (!hasElev) {
        elevNoteEl.style.display = "block";
        elevStatsEl.textContent = "no elevation";
        return;
      }

      const distKm = new Array(pointsLonLatEle.length).fill(0);
      for (let i = 1; i < pointsLonLatEle.length; i++) {
        distKm[i] =
          distKm[i-1] +
          haversineMeters(
            pointsLonLatEle[i-1][1], pointsLonLatEle[i-1][0],
            pointsLonLatEle[i][1],   pointsLonLatEle[i][0]
          ) / 1000;
      }

      const elevVals = elev.filter(v => v !== null);
      const minE = Math.min(...elevVals);
      const maxE = Math.max(...elevVals);

      let gain = 0, loss = 0;
      for (let i = 1; i < elev.length; i++) {
        if (elev[i] === null || elev[i-1] === null) continue;
        const de = elev[i] - elev[i-1];
        if (de > 0) gain += de; else loss += -de;
      }

      elevStatsEl.textContent =
        `${distKm[distKm.length-1].toFixed(1)} km • ↑ ${Math.round(gain)} m • ↓ ${Math.round(loss)} m • ${Math.round(minE)}–${Math.round(maxE)} m`;

      const trace = {
        x: distKm,
        y: elev,
        type: "scatter",
        mode: "lines",
        line: { width: 3 },
        hovertemplate: "%{x:.2f} km<br>%{y:.0f} m<extra></extra>"
      };

      const layout = {
        margin: { l: 50, r: 12, t: 6, b: 36 },
        xaxis: { title: "Distance (km)", fixedrange: false },
        yaxis: { title: "Elevation (m)", fixedrange: false },
        dragmode: "pan",
        hovermode: "x",
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)"
      };

      const config = {
        displayModeBar: false,
        responsive: true,
        scrollZoom: true
      };

      Plotly.newPlot("elevPlot", [trace], layout, config);
    }

    // ==========================
    // Load data, draw line, fit bounds
    // ==========================
    fetch(detailUrl)
      .then(r => {
        if (!r.ok) throw new Error(`Failed to load GeoJSON (${r.status})`);
        return r.json();
      })
      .then(gj => {
        const pts = extractFirstLineCoords(gj);
        if (!pts || pts.length < 2) throw new Error("Not enough coordinates to draw.");

        const lineCoords = pts
          .map(p => [p[0], p[1]])
          .filter(p => Number.isFinite(p[0]) && Number.isFinite(p[1]));

        if (lineCoords.length < 2) throw new Error(`Not enough coordinate points (${lineCoords.length}).`);

        map.on("load", () => {
          enable3DTerrain();

          // NOTE: lineMetrics:true enables line-gradient with line-progress
          map.addSource("tour", {
            type: "geojson",
            lineMetrics: true,
            data: {
              type: "Feature",
              geometry: { type: "LineString", coordinates: lineCoords }
            }
          });

          // Base line (solid)
          map.addLayer({
            id: "tour-line",
            type: "line",
            source: "tour",
            layout: { "line-join":"round", "line-cap":"round" },
            paint: {
              "line-color": "#111",
              "line-width": 4,
              "line-opacity": 0.95
            }
          });

          // Gradient overlay line (hidden by default; toggled by checkbox)
          map.addLayer({
            id: "tour-line-gradient",
            type: "line",
            source: "tour",
            layout: {
              "line-join":"round",
              "line-cap":"round",
              "visibility": "none"
            },
            paint: {
              "line-width": 5,
              "line-opacity": 0.95,
              // Gradient by progress along the line (0 -> 1)
              "line-gradient": [
                "interpolate",
                ["linear"],
                ["line-progress"],
                0.00, "#1f6feb",
                0.33, "#22c55e",
                0.66, "#f59e0b",
                1.00, "#ef4444"
              ]
            }
          });

          // start + end points
          map.addSource("start", {
            type: "geojson",
            data: { type: "Feature", geometry: { type: "Point", coordinates: lineCoords[0] } }
          });
          map.addLayer({
            id: "start-pt",
            type: "circle",
            source: "start",
            paint: {
              "circle-radius": 6,
              "circle-color": "#111",
              "circle-stroke-width": 2,
              "circle-stroke-color": "#fff"
            }
          });

          map.addSource("end", {
            type: "geojson",
            data: { type: "Feature", geometry: { type: "Point", coordinates: lineCoords[lineCoords.length - 1] } }
          });
          map.addLayer({
            id: "end-pt",
            type: "circle",
            source: "end",
            paint: {
              "circle-radius": 6,
              "circle-color": "#111",
              "circle-stroke-width": 2,
              "circle-stroke-color": "#fff",
              "circle-opacity": 0.85
            }
          });

          // fit bounds
          const bounds = lineCoords.reduce(
            (b, c) => b.extend(c),
            new mapboxgl.LngLatBounds(lineCoords[0], lineCoords[0])
          );
          map.fitBounds(bounds, { padding: 60, duration: 0 });

          // elevation plot
          renderElevationPlot(pts);
        });
      })
      .catch(err => showError(err.message || String(err)));
  </script>
</body>
</html>
